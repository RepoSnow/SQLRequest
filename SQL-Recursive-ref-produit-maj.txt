GO
	Declare @cpt int, @idcount int;
		set @cpt =  1;
		print @idcount

	While @cpt <= @idcount
		begin
			with loop ( rang, p1, origin, p2, destination,profondeur, id) as

			(

				select 'Parent' as rang ,period, Origincode, null p2, Destinationcode,1, id
				from [dbo].[ref_prod] 
				where id  =@cpt

				union all 

				select 'Enfant' as rang ,b.p1, a.Origincode, a.period, a.Destinationcode, profondeur +1, a.id
				from  [dbo].[ref_prod] a
				inner join loop b on a.Origincode = b.destination and a.id between b.id +1 and @idcount 
			
			)
	
			insert into new_ref_prod(rang ,p1, origin, p2, destination,deep, id)
			select 
			case 
				when rang = 'Parent' then space(profondeur) + rang 
				when rang = 'enfant' then space(profondeur*2) + rang 
			end rang,p1,origin, p2, destination, profondeur, id
			from loop
			print @cpt
			set @cpt = @cpt + 1
		
		 end

GO

select * from ref_prod
select * from new_ref_prod
